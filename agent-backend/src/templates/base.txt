import autogen
from autogen import AssistantAgent, GroupChat, GroupChatManager, UserProxyAgent
from init.env_variables import SOCKET_URL, BASE_PATH
from socketio.simple_client import SimpleClient
from random import randint

session_id = f"{{session_id}}"

socket = SimpleClient()
socket.connect(url=SOCKET_URL)
socket.emit("join_room", f"_{session_id}")

{% for role in roles %}
{{ role.name }}_config = {
    "seed": randint(1, 1000),
    "temperature": 0,
    "request_timeout": 300,
    "retry_wait_time": 60,
    "config_list":[{
        "api_key" : "{{role.key}}",
        "api_type" : "{{role.platform}}",
        "model" : "{{role.model}}"
        }]
}
{% endfor %}

{% for n in range(roles | length) %}
{% if roles[n].is_user_proxy %}
user_proxy = UserProxyAgent(
    name="admin",
    llm_config=admin_config,
    system_message="""{{ roles[n].system_message }}""",
    human_input_mode="{{ roles[n].human_input_mode | default(ALWAYS) }}",
    code_execution_config={{ roles[n].code_execution_config | default(False) }},
    use_sockets=True,
    socket_client=socket,
    sid=session_id
)
{% else %}
agent_{{n}} = {{ roles[n].type }}(
    name="{{ roles[n].name | format }}",
    llm_config={{ roles[n].name}}_config,
    system_message="""{{ roles[n].system_message }}""",
    human_input_mode="{{ roles[n].human_input_mode | default(NEVER) }}",
    code_execution_config={{ roles[n].code_execution_config| default(False) }},
    use_sockets=True,
    socket_client=socket,
    sid=session_id
)
{% endif %}
{% endfor %}

{% if group_chat %}
groupchat = GroupChat(agents=[{% for n in range(roles | length) %}agent_{{n}},{% endfor %}], messages=[], max_round=50)
manager = GroupChatManager( groupchat=groupchat, llm_config=agent_1, use_sockets=True, socket_client=socket, sid=session_id)
{% endif %}