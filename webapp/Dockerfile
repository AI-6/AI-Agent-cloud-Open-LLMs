FROM node:latest

WORKDIR /app
ENV NODE_ENV production

RUN touch /app/.env
COPY package.json /app
COPY package-lock.json /app
RUN npm install

ARG SHORT_COMMIT_HASH
ENV NEXT_PUBLIC_SHORT_COMMIT_HASH=$SHORT_COMMIT_HASH

ARG POSTHOG_KEY
ENV NEXT_PUBLIC_POSTHOG_KEY=$POSTHOG_KEY

ARG NEXT_PUBLIC_NO_PAYMENT_REQUIRED
ENV NEXT_PUBLIC_NO_PAYMENT_REQUIRED=$NEXT_PUBLIC_NO_PAYMENT_REQUIRED

ARG NEXT_PUBLIC_ENABLE_GOOGLE_OAUTH
ENV NEXT_PUBLIC_ENABLE_GOOGLE_OAUTH=$NEXT_PUBLIC_ENABLE_GOOGLE_OAUTH

ARG NEXT_PUBLIC_ENABLE_GITHUB_OAUTH
ENV NEXT_PUBLIC_ENABLE_GITHUB_OAUTH=$NEXT_PUBLIC_ENABLE_GITHUB_OAUTH

ARG NEXT_PUBLIC_GCS_BUCKET_NAME
ENV NEXT_PUBLIC_GCS_BUCKET_NAME=$NEXT_PUBLIC_GCS_BUCKET_NAME

ARG GOOGLE_KEYPATH
COPY $GOOGLE_KEYPATH /app/keyfile.json
ENV GOOGLE_APPLICATION_CREDENTIALS=/app/keyfile.json

COPY . /app

RUN npx next telemetry disable
RUN npm run build

EXPOSE 3000

CMD ["npm", "run", "start"]
